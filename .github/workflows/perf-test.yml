name: Performance Testing

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'network.py'
      - 'link.py'
      - 'node.py'
      - 'path.py'
      - 'od.py'
      - 'utils.py'
      - 'tests/**'
      - '.github/workflows/perf-test.yml'

jobs:
  performance-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        path: candidate
    
    - name: Checkout baseline (main)
      uses: actions/checkout@v4
      with:
        ref: main
        path: baseline
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies (baseline)
      working-directory: baseline
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Install dependencies (candidate)
      working-directory: candidate
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Run baseline performance tests
      working-directory: baseline
      run: |
        python -m tests.run_protocol \
          --tests tests/protocol/siouxfalls_10_aec.txt tests/protocol/siouxfalls_eqm_aec.txt \
          --func averageExcessCost \
          --runs 5 \
          --output ../baseline_results.csv \
          --json ../baseline_results.json
    
    - name: Run candidate performance tests
      working-directory: candidate
      run: |
        python -m tests.run_protocol \
          --tests tests/protocol/siouxfalls_10_aec.txt tests/protocol/siouxfalls_eqm_aec.txt \
          --func averageExcessCost \
          --runs 5 \
          --output ../candidate_results.csv \
          --json ../candidate_results.json
    
    - name: Compare results
      working-directory: candidate
      run: |
        python -m tests.compare_results \
          ../baseline_results.csv \
          ../candidate_results.csv \
          --format markdown > ../comparison.md
        cat ../comparison.md
    
    - name: Upload baseline results
      uses: actions/upload-artifact@v4
      with:
        name: baseline-results
        path: |
          baseline_results.csv
          baseline_results.json
    
    - name: Upload candidate results
      uses: actions/upload-artifact@v4
      with:
        name: candidate-results
        path: |
          candidate_results.csv
          candidate_results.json
    
    - name: Upload comparison
      uses: actions/upload-artifact@v4
      with:
        name: performance-comparison
        path: comparison.md
    
    - name: Comment PR with results
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const fs = require('fs');
          const comparison = fs.readFileSync('comparison.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comparison
          });
